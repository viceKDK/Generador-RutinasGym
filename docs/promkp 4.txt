import React, { useState } from 'react';
import { Check, CheckCircle2 } from 'lucide-react';
import * as LucideIcons from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { EQUIPMENT_CATEGORIES, EQUIPMENT_PRESETS, EQUIPMENT_LABELS } from '@/data/equipment';
import { EquipmentType } from '@/types/equipment';
import { cn } from '@/lib/utils';

interface EquipmentSelectorProps {
  selectedEquipment: EquipmentType[];
  onEquipmentChange: (equipment: EquipmentType[]) => void;
  showPresets?: boolean;
  allowMultipleSelection?: boolean;
}

export const EquipmentSelector: React.FC<EquipmentSelectorProps> = ({
  selectedEquipment,
  onEquipmentChange,
  showPresets = true,
  allowMultipleSelection = true,
}) => {
  const [expandedCategories, setExpandedCategories] = useState<string[]>([]);

  const toggleCategory = (categoryId: string) => {
    const category = EQUIPMENT_CATEGORIES.find(cat => cat.id === categoryId);
    if (!category) return;

    const categoryEquipment = category.equipment;
    const isFullySelected = categoryEquipment.every(eq => selectedEquipment.includes(eq));

    if (isFullySelected) {
      // Deselect all equipment in this category
      onEquipmentChange(selectedEquipment.filter(eq => !categoryEquipment.includes(eq)));
    } else {
      // Select all equipment in this category
      const newEquipment = [...selectedEquipment];
      categoryEquipment.forEach(eq => {
        if (!newEquipment.includes(eq)) {
          newEquipment.push(eq);
        }
      });
      onEquipmentChange(newEquipment);
    }
  };

  const toggleEquipment = (equipment: EquipmentType) => {
    if (allowMultipleSelection) {
      if (selectedEquipment.includes(equipment)) {
        onEquipmentChange(selectedEquipment.filter(eq => eq !== equipment));
      } else {
        onEquipmentChange([...selectedEquipment, equipment]);
      }
    } else {
      onEquipmentChange([equipment]);
    }
  };

  const selectAll = () => {
    const allEquipment = EQUIPMENT_CATEGORIES.flatMap(cat => cat.equipment);
    onEquipmentChange(allEquipment);
  };

  const clearAll = () => {
    onEquipmentChange([]);
  };

  const applyPreset = (presetId: string) => {
    const preset = EQUIPMENT_PRESETS.find(p => p.id === presetId);
    if (preset) {
      onEquipmentChange(preset.equipment);
    }
  };

  const toggleCategoryExpansion = (categoryId: string) => {
    setExpandedCategories(prev =>
      prev.includes(categoryId)
        ? prev.filter(id => id !== categoryId)
        : [...prev, categoryId]
    );
  };

  const isCategorySelected = (categoryId: string) => {
    const category = EQUIPMENT_CATEGORIES.find(cat => cat.id === categoryId);
    if (!category) return false;
    return category.equipment.some(eq => selectedEquipment.includes(eq));
  };

  const isCategoryFullySelected = (categoryId: string) => {
    const category = EQUIPMENT_CATEGORIES.find(cat => cat.id === categoryId);
    if (!category) return false;
    return category.equipment.every(eq => selectedEquipment.includes(eq));
  };

  const getIcon = (iconName: string) => {
    const Icon = (LucideIcons as any)[iconName];
    return Icon ? <Icon size={32} /> : <LucideIcons.Package size={32} />;
  };

  return (
    <div className="space-y-6">
      {/* Header Controls */}
      <div className="flex flex-wrap items-center justify-between gap-4">
        <div className="flex items-center gap-4">
          <h2 className="text-2xl font-bold text-foreground">Equipamiento Disponible</h2>
          <Badge variant="secondary" className="text-sm">
            {selectedEquipment.length} seleccionados
          </Badge>
        </div>

        <div className="flex flex-wrap gap-2">
          <Button
            variant="outline"
            onClick={selectAll}
            className="hover:bg-gym-hover"
          >
            Seleccionar Todo
          </Button>
          <Button
            variant="outline"
            onClick={clearAll}
            className="hover:bg-gym-hover"
          >
            Limpiar Todo
          </Button>
        </div>
      </div>

      {/* Presets */}
      {showPresets && (
        <div className="space-y-3">
          <h3 className="text-lg font-semibold text-foreground">Configuraciones Rápidas</h3>
          <div className="flex flex-wrap gap-2">
            {EQUIPMENT_PRESETS.map(preset => (
              <Button
                key={preset.id}
                variant="secondary"
                onClick={() => applyPreset(preset.id)}
                className="bg-gym-primary/10 hover:bg-gym-primary/20 text-gym-primary border-gym-primary/20"
              >
                {preset.name}
              </Button>
            ))}
          </div>
          <Separator />
        </div>
      )}

      {/* Equipment Categories */}
      <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
        {EQUIPMENT_CATEGORIES.map(category => {
          const isSelected = isCategorySelected(category.id);
          const isFullySelected = isCategoryFullySelected(category.id);
          const isExpanded = expandedCategories.includes(category.id);

          return (
            <Card
              key={category.id}
              className={cn(
                "transition-all duration-200 cursor-pointer border-2",
                isSelected
                  ? "border-gym-primary bg-gym-primary/5"
                  : "border-border hover:border-gym-primary/50 hover:bg-gym-hover"
              )}
            >
              <CardContent className="p-6">
                <div
                  onClick={() => toggleCategory(category.id)}
                  className="flex items-center justify-between mb-4"
                >
                  <div className="flex items-center gap-4">
                    <div className={cn(
                      "p-3 rounded-lg transition-colors",
                      isSelected ? "bg-gym-primary text-white" : "bg-muted text-muted-foreground"
                    )}>
                      {getIcon(category.icon)}
                    </div>
                    <div>
                      <h3 className="font-semibold text-lg text-foreground">
                        {category.name}
                      </h3>
                      <p className="text-sm text-muted-foreground">
                        {category.equipment.filter(eq => selectedEquipment.includes(eq)).length}/{category.equipment.length} seleccionados
                      </p>
                    </div>
                  </div>

                  <div className="flex items-center gap-2">
                    {isFullySelected && (
                      <CheckCircle2 className="w-6 h-6 text-gym-success" />
                    )}
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={(e) => {
                        e.stopPropagation();
                        toggleCategoryExpansion(category.id);
                      }}
                      className="hover:bg-gym-hover"
                    >
                      {isExpanded ? '▼' : '▶'}
                    </Button>
                  </div>
                </div>

                {/* Individual Equipment Items */}
                {isExpanded && (
                  <div className="space-y-2 pl-2 border-l-2 border-gym-primary/20">
                    {category.equipment.map(equipment => (
                      <div
                        key={equipment}
                        onClick={() => toggleEquipment(equipment)}
                        className={cn(
                          "flex items-center gap-3 p-2 rounded-md cursor-pointer transition-colors text-sm",
                          selectedEquipment.includes(equipment)
                            ? "bg-gym-primary/10 text-gym-primary"
                            : "hover:bg-gym-hover text-foreground"
                        )}
                      >
                        <div className={cn(
                          "w-5 h-5 rounded border-2 flex items-center justify-center",
                          selectedEquipment.includes(equipment)
                            ? "bg-gym-primary border-gym-primary"
                            : "border-muted-foreground"
                        )}>
                          {selectedEquipment.includes(equipment) && (
                            <Check className="w-3 h-3 text-white" />
                          )}
                        </div>
                        <span>{EQUIPMENT_LABELS[equipment]}</span>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>
          );
        })}
      </div>
    </div>
  );
};
