import React, { useEffect, useState } from 'react';
import { CheckCircle2, XCircle, AlertCircle, Loader2, X, Brain, Zap } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils';

export type ProgressState = 'hidden' | 'indeterminate' | 'determinate' | 'success' | 'error';

export interface ProgressIndicatorProps {
  state: ProgressState;
  progressValue?: number; // 0-100 for determinate progress
  statusMessage: string;
  subMessage?: string;
  estimatedTimeRemaining?: number; // in seconds
  showCancelButton?: boolean;
  aiMode?: 'local' | 'basic' | null;
  onCancel?: () => void;
  onRetry?: () => void;
  className?: string;
}

const formatTime = (seconds: number): string => {
  if (seconds < 60) return `${seconds}s`;
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = seconds % 60;
  return `${minutes}m ${remainingSeconds}s`;
};

export const ProgressIndicator: React.FC<ProgressIndicatorProps> = ({
  state,
  progressValue = 0,
  statusMessage,
  subMessage,
  estimatedTimeRemaining,
  showCancelButton = false,
  aiMode,
  onCancel,
  onRetry,
  className,
}) => {
  const [displayProgress, setDisplayProgress] = useState(0);

  // Smooth progress animation
  useEffect(() => {
    if (state === 'determinate' && progressValue !== displayProgress) {
      const timer = setTimeout(() => {
        const diff = progressValue - displayProgress;
        const step = Math.sign(diff) * Math.min(Math.abs(diff), 2);
        setDisplayProgress(prev => prev + step);
      }, 50);
      return () => clearTimeout(timer);
    }
  }, [progressValue, displayProgress, state]);

  if (state === 'hidden') return null;

  const getStateIcon = () => {
    switch (state) {
      case 'success':
        return <CheckCircle2 className="w-6 h-6 text-success animate-check-bounce" />;
      case 'error':
        return <XCircle className="w-6 h-6 text-destructive" />;
      case 'indeterminate':
      case 'determinate':
        return <Loader2 className="w-6 h-6 text-primary animate-spin" />;
      default:
        return null;
    }
  };

  const getAiModeIndicator = () => {
    if (!aiMode) return null;
    return (
      <div className={cn(
        "flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium",
        aiMode === 'local'
          ? "bg-gradient-primary text-primary-foreground shadow-primary"
          : "bg-muted text-muted-foreground"
      )}>
        {aiMode === 'local' ? (
          <>
            <Brain className="w-3 h-3" />
            IA Local (Ollama)
          </>
        ) : (
          <>
            <Zap className="w-3 h-3" />
            Modo Básico
          </>
        )}
      </div>
    );
  };

  const getProgressBarColor = () => {
    switch (state) {
      case 'success':
        return 'bg-gradient-success';
      case 'error':
        return 'bg-destructive';
      default:
        return 'bg-gradient-primary';
    }
  };

  return (
    <div className={cn(
      "bg-card border rounded-xl p-6 shadow-lg backdrop-blur-sm animate-fade-in-up",
      state === 'success' && "border-success/20 shadow-success",
      state === 'error' && "border-destructive/20",
      className
    )}>
      <div className="space-y-4">
        {/* Header with icon and AI mode */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            {getStateIcon()}
            <div className="flex-1">
              <h3 className="text-lg font-semibold text-foreground">
                {statusMessage}
              </h3>
              {subMessage && (
                <p className="text-sm text-muted-foreground mt-1">
                  {subMessage}
                </p>
              )}
            </div>
          </div>
          {getAiModeIndicator()}
        </div>

        {/* Progress Bar */}
        <div className="relative">
          <div className="w-full bg-muted rounded-full h-3 overflow-hidden">
            {state === 'indeterminate' ? (
              <div className={cn(
                "h-full w-1/3 rounded-full animate-progress-flow",
                getProgressBarColor()
              )} />
            ) : (
              <div
                className={cn(
                  "h-full rounded-full transition-all duration-500 ease-out",
                  getProgressBarColor()
                )}
                style={{ width: `${Math.max(displayProgress, 2)}%` }}
              />
            )}
          </div>

          {/* Progress percentage */}
          {state === 'determinate' && (
            <div className="absolute -top-6 right-0 text-xs text-muted-foreground font-medium">
              {Math.round(displayProgress)}%
            </div>
          )}
        </div>

        {/* Time estimation and actions */}
        <div className="flex items-center justify-between">
          <div className="text-sm text-muted-foreground">
            {estimatedTimeRemaining && estimatedTimeRemaining > 0 && (
              <span>Tiempo estimado: {formatTime(estimatedTimeRemaining)}</span>
            )}
            {state === 'success' && (
              <span className="text-success font-medium">¡Completado exitosamente!</span>
            )}
            {state === 'error' && (
              <span className="text-destructive font-medium">Error en el procesamiento</span>
            )}
          </div>

          <div className="flex items-center gap-2">
            {state === 'error' && onRetry && (
              <Button
                variant="outline"
                size="sm"
                onClick={onRetry}
                className="hover:bg-primary hover:text-primary-foreground"
              >
                Reintentar
              </Button>
            )}

            {showCancelButton && onCancel && (state === 'indeterminate' || state === 'determinate') && (
              <Button
                variant="ghost"
                size="sm"
                onClick={onCancel}
                className="hover:bg-destructive hover:text-destructive-foreground"
              >
                <X className="w-4 h-4 mr-1" />
                Cancelar
              </Button>
            )}
          </div>
        </div>

        {/* Success glow effect */}
        {state === 'success' && (
          <div className="absolute inset-0 rounded-xl bg-gradient-success opacity-5 animate-pulse-glow pointer-events-none" />
        )}
      </div>
    </div>
  );
};
